# 使用方式
- 安装好python3.10与ubuntu中debian软件包中的openjdk（下载其中的最新版本即可，在命令行输入jdk可以看到）
- 确保安装好 **joern**，同时设置好了 **joern** 以及 **joern-parse** 的环境变量
- 依赖库
    - `pip3 install cpgqls-client`
    - `pip3 install igraph`
    - `pip3 install alive-progress`
- 将需要解析的代码文件或者项目的文件夹复制到 **testcase** 目录下
- 注意到 **testcase** 目录下每个文件夹都是分别的一个项目，每个项目中仅有一个文件夹，文件夹中仅有一个文件，文件中仅有一个函数
- 注意到 **testcase** 目录下所有文件同属项目 **tmpdir**
- 执行 `python3 main.py` 进行切片处理
- 执行 `python3 clean` 可以清理目录
- 由于进度条定制了输出，所以多进程中不能有 print 函数，否则会卡死

# 未能良好实现的功能
- joern server 的退出：目前使用命令行指令直接杀死，需要 joern 官方提供退出方式
- joern 在 importCode 之后并没有直接生成 ddg，和官方文档不符，故还要再跑一次 `run.ossdataflow`，需要官方去解决（已经被官方收录）
- joern server 返回的信息里面 **success** 项永远是 **False**，这里需要官方去解决
- joern 的 **map** 语法不够强大，无法一步到位，对于输出的 json 文件还需要进行修正
- joern 多个项目分多次解析效率太低，目前只能一次解析多个项目
- joern 能够识别结构体中的函数，但是无法识别结构体变量的定义，结构体变量调用内部函数会被指向 External，相当于空指针
- 函数内的函数指针被识别为一个函数，导致函数的 AST 中有另一个函数，目前影响未知
- 对于没有赋值的变量定义语句，原生没有连接该语句的边，目前的补丁只能在后向切片中添加定义语句，前向无法添加
    - 需要评估其重要性
    - 一种可行方案是，记录每个 identifier 节点对应的 local 节点，在切片完成后于每个首次引用的位置添加定义语句
- 目前没有办法在生成节点属性的时候直接筛选出我们想要的属性
- joern **ref** 只能跨一个 **block** 识别，**for** 循环语句里面定义部分单独为一个 **block**，里面的定义无法ref联系到循环控制语句、循环变量赋值语句、循环体内语句的 **identifier** 节点， joern 不应该将 **for** 循环语句里面定义部分单独为一个 **block**
- DAG 目前的排序依据是:
    1. 深度
    2. 代码顺序
    - 其中代码顺序可能导致输出结果时的顺序不是最佳顺序，但是目前没有想到合适的顺序（算法）
    
# 测试说明

* 本次任务工作在 MatchSinkPointCode 分支下。
* 主要修改的文件是`syvc_module\syvc_matcher.py`， syvc 指 Syntax-based Vulnerability Candidates，即语法相关的漏洞候选项。文件里的每个函数，分别对应于一种漏洞的匹配方式。
* 函数形如`array_matcher(node, node_dict, def_flag)`，第一个参数是节点的编号，第二个是节点字典，后面可使用的参数有 def_flag, as_flag, ast等，目前不明白具体含义。函数的返回值是布尔值，True 表示这个节点是漏洞候选项。
* 函数被调用位置在`graph_module\graph_class.py`函数的 `AST` 类的 `get_slice_src`方法里。将最新提交中的 73 行的 `syvc_matcher.ae_matcher` 中的函数改为需要测试的函数即可进行调用。
* 如果一切正常，最后筛选出的 Sink 点代码将位于 `slice_module/slice_result/tmp/sink_code.json` 中。